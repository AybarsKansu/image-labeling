(function(){"use strict";self.onmessage=async function(o){const{type:t,payload:a}=o.data;switch(t){case"PROCESS_FILES":try{const e=await g(a.files);self.postMessage({type:"PROCESS_COMPLETE",payload:e})}catch(e){self.postMessage({type:"PROCESS_ERROR",payload:{error:e.message}})}break;case"GENERATE_THUMBNAIL":try{const e=await generateThumbnail(a.blob,a.maxSize||100);self.postMessage({type:"THUMBNAIL_COMPLETE",payload:{id:a.id,thumbnail:e}})}catch(e){self.postMessage({type:"THUMBNAIL_ERROR",payload:{id:a.id,error:e.message}})}break;default:console.warn("Unknown message type:",t)}};async function g(o){const t=[],a=[];let e=null;for(const s of o){const n=s.name.split(".").pop().toLowerCase(),i=s.name.replace(/\.[^/.]+$/,"");s.name==="classes.txt"?e=await m(s):["jpg","jpeg","png","webp","bmp","gif"].includes(n)?t.push({file:s,baseName:i,ext:n}):["txt","xml","json"].includes(n)&&a.push({file:s,baseName:i,ext:n})}let l=[];e&&(l=b(e));const r=[];for(let s=0;s<t.length;s++){const n=t[s];let i=null,c=0,h=0;try{const p=await createImageBitmap(n.file);c=p.width,h=p.height,i=await d(p,100),p.close()}catch(p){console.warn(`Failed to process image ${n.file.name}:`,p)}r.push({name:n.file.name,baseName:n.baseName,path:n.file.webkitRelativePath||"",type:"image",blob:n.file,thumbnail:i,width:c,height:h}),self.postMessage({type:"PROCESS_PROGRESS",payload:{processed:s+1,total:t.length+a.length}})}const f=[];for(let s=0;s<a.length;s++){const n=a[s],i=await m(n.file);if(l.length===0){const c=u(i);c.length>0&&(l=c)}f.push({name:n.file.name,baseName:n.baseName,path:n.file.webkitRelativePath||"",type:"label",data:i}),self.postMessage({type:"PROCESS_PROGRESS",payload:{processed:t.length+s+1,total:t.length+a.length}})}return{images:r,labels:f,classNames:l}}async function d(o,t=100){const{width:a,height:e}=o;let l,r;a>e?(l=t,r=Math.round(e/a*t)):(r=t,l=Math.round(a/e*t));const f=new OffscreenCanvas(l,r);f.getContext("2d").drawImage(o,0,0,l,r);const i=await(await f.convertToBlob({type:"image/jpeg",quality:.7})).arrayBuffer();return`data:image/jpeg;base64,${btoa(String.fromCharCode(...new Uint8Array(i)))}`}function m(o){return new Promise((t,a)=>{const e=new FileReader;e.onload=()=>t(e.result),e.onerror=()=>a(e.error),e.readAsText(o)})}function b(o){return o.split(`
`).map(t=>t.trim()).filter(t=>t.length>0&&!t.startsWith("#"))}function u(o){const t=o.split(`
`);for(const a of t){const e=a.match(/^#\s*classes?:\s*(.+)$/i);if(e)return e[1].split(",").map(l=>l.trim()).filter(l=>l)}return[]}})();
