(function(){"use strict";self.onmessage=async function(l){const{type:e,payload:a}=l.data;switch(e){case"PROCESS_FILES":try{const t=await d(a.files);self.postMessage({type:"PROCESS_COMPLETE",payload:t})}catch(t){self.postMessage({type:"PROCESS_ERROR",payload:{error:t.message}})}break;case"GENERATE_THUMBNAIL":try{const t=await generateThumbnail(a.blob,a.maxSize||100);self.postMessage({type:"THUMBNAIL_COMPLETE",payload:{id:a.id,thumbnail:t}})}catch(t){self.postMessage({type:"THUMBNAIL_ERROR",payload:{id:a.id,error:t.message}})}break;default:console.warn("Unknown message type:",e)}};async function d(l){const e=[],a=[];let t=null;for(const n of l){const s=n.file||n;n._customPath&&(s._customPath=n._customPath);const i=s.name.split(".").pop().toLowerCase(),r=s.name.replace(/\.[^/.]+$/,"");s.name==="classes.txt"?t=await f(s):["jpg","jpeg","png","webp","bmp","gif"].includes(i)?e.push({file:s,baseName:r,ext:i}):["txt","xml","json"].includes(i)&&a.push({file:s,baseName:r,ext:i})}const o=[];for(let n=0;n<e.length;n++){const s=e[n];let i=null,r=0,m=0;try{const p=await createImageBitmap(s.file);r=p.width,m=p.height,i=await g(p,100),p.close()}catch(p){console.warn(`Failed to process image ${s.file.name}:`,p)}o.push({name:s.file.name,baseName:s.baseName,path:h(s.file),type:"image",blob:s.file,thumbnail:i,width:r,height:m}),self.postMessage({type:"PROCESS_PROGRESS",payload:{processed:n+1,total:e.length+a.length}})}const c=[];for(let n=0;n<a.length;n++){const s=a[n],i=await f(s.file),r=b(i);c.push({name:s.file.name,baseName:s.baseName,path:h(s.file),type:"label",data:i,embeddedClasses:r}),self.postMessage({type:"PROCESS_PROGRESS",payload:{processed:e.length+n+1,total:e.length+a.length}})}return{images:o,labels:c,classNames:t?u(t):[],isGlobalClasses:!!t}}function h(l){let e=l._customPath||l.path||l.webkitRelativePath||"";return typeof e=="string"&&e.startsWith("/")&&(e=e.substring(1)),e}async function g(l,e=100){const{width:a,height:t}=l;let o,c;a>t?(o=e,c=Math.round(t/a*e)):(c=e,o=Math.round(a/t*e));const n=new OffscreenCanvas(o,c);n.getContext("2d").drawImage(l,0,0,o,c);const r=await(await n.convertToBlob({type:"image/jpeg",quality:.7})).arrayBuffer();return`data:image/jpeg;base64,${btoa(String.fromCharCode(...new Uint8Array(r)))}`}function f(l){return new Promise((e,a)=>{const t=new FileReader;t.onload=()=>e(t.result),t.onerror=()=>a(t.error),t.readAsText(l)})}function u(l){return l.split(`
`).map(e=>e.trim()).filter(e=>e.length>0&&!e.startsWith("#"))}function b(l){const e=l.split(`
`);for(const a of e){const t=a.match(/^#\s*classes?:\s*(.+)$/i);if(t)return t[1].split(",").map(o=>o.trim()).filter(o=>o)}return[]}})();
